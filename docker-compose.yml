# ===================================================================================
# WHATSAPP SUPPORT (GENFITY-WA-SUPPORT) - DOCKER COMPOSE (LOCAL DEVELOPMENT)
# ===================================================================================
# 
# Gateway service untuk WhatsApp API dengan subscription validation & rate limiting
# Builds images locally from source code
# All values MUST be set in .env file
#
# USAGE:
#   cp .env.example .env   # Edit with your values
#   docker compose up -d --build
#
# ===================================================================================

services:
  wa-support:
    build:
      context: .
      dockerfile: Dockerfile
    image: genfity-wa-support:local
    container_name: wa-support
    ports:
      - "${PORT}:${PORT}"
    environment:
      # Primary Database
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      DB_SSLMODE: ${DB_SSLMODE}
      
      # Transactional Database
      TRANSACTIONAL_DB_HOST: ${TRANSACTIONAL_DB_HOST}
      TRANSACTIONAL_DB_PORT: ${TRANSACTIONAL_DB_PORT}
      TRANSACTIONAL_DB_USER: ${TRANSACTIONAL_DB_USER}
      TRANSACTIONAL_DB_PASSWORD: ${TRANSACTIONAL_DB_PASSWORD}
      TRANSACTIONAL_DB_NAME: ${TRANSACTIONAL_DB_NAME}
      TRANSACTIONAL_DB_SSLMODE: ${TRANSACTIONAL_DB_SSLMODE}
      
      # Application
      PORT: ${PORT}
      TZ: ${TZ}
      GIN_MODE: ${GIN_MODE}
      LOG_LEVEL: ${LOG_LEVEL}
      
      # Gateway Configuration
      GATEWAY_MODE: ${GATEWAY_MODE}
      RATE_LIMIT_WINDOW: ${RATE_LIMIT_WINDOW:-60}
      DEFAULT_RATE_LIMIT: ${DEFAULT_RATE_LIMIT:-100}
      
      # WhatsApp API Backend
      WA_SERVER_URL: ${WA_SERVER_URL}
      WA_ADMIN_TOKEN: ${WA_ADMIN_TOKEN}
      
      # Authentication
      WEBHOOK_VERIFY_TOKEN: ${WEBHOOK_VERIFY_TOKEN}
      ADMIN_TOKEN: ${ADMIN_TOKEN}
    networks:
      - wa-network
      - infra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      # Traefik
      - "traefik.enable=true"
      - "traefik.http.routers.wa-support.rule=Host(`wa.genfity.com`)"
      - "traefik.http.routers.wa-support.entrypoints=websecure"
      - "traefik.http.routers.wa-support.tls.certresolver=letsencrypt"
      - "traefik.http.services.wa-support.loadbalancer.server.port=8082"
      - "traefik.http.routers.wa-support.middlewares=wa-support-cors"
      - "traefik.http.middlewares.wa-support-cors.headers.accessControlAllowOriginList=https://genfity.com,https://www.genfity.com"
      - "traefik.http.middlewares.wa-support-cors.headers.accessControlAllowMethods=GET,POST,PUT,DELETE,OPTIONS"
      - "traefik.http.middlewares.wa-support-cors.headers.accessControlAllowHeaders=Content-Type,Authorization"

networks:
  wa-network:
    external: true
    name: wa-network
  infra-network:
    external: true
    name: infra-network
